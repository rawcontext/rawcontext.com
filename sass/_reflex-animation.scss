// ============================================
// CACHE CASCADE - Reflex Animation
// Three-tier caching visualization
// ============================================

// Layout for project header with visual
.project-header-layout {
    &.has-visual {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
        align-items: start;

        .project-header {
            max-width: none;
        }
    }
}

.project-visual {
    position: relative;
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
}

// Main container
.cache-cascade {
    position: relative;
    width: 340px;
    height: 340px;
    transform-style: preserve-3d;
    perspective: 800px;
}

// Ambient floating particles
.cascade-field {
    position: absolute;
    inset: -40px;
    pointer-events: none;
}

.field-particle {
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--signal-primary);
    border-radius: 50%;
    opacity: 0.3;

    &:nth-child(1) { top: 10%; left: 15%; animation: fieldFloat 8s ease-in-out infinite; }
    &:nth-child(2) { top: 25%; left: 85%; animation: fieldFloat 10s ease-in-out 1s infinite; }
    &:nth-child(3) { top: 70%; left: 10%; animation: fieldFloat 9s ease-in-out 2s infinite; }
    &:nth-child(4) { top: 85%; left: 75%; animation: fieldFloat 11s ease-in-out 0.5s infinite; }
    &:nth-child(5) { top: 45%; left: 5%; animation: fieldFloat 7s ease-in-out 3s infinite; }
    &:nth-child(6) { top: 60%; left: 92%; animation: fieldFloat 12s ease-in-out 1.5s infinite; }
}

// Cache tier base styles
.cache-tier {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
}

.tier-ring {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 1px solid;
}

// ============================================
// L3 - Verification Ring (Outermost)
// ============================================
.tier-l3 {
    width: 100%;
    height: 100%;

    .tier-ring {
        border-color: rgba(255, 200, 87, 0.15);
        border-style: dashed;
        animation: l3Rotate 60s linear infinite;
    }
}


.verification-pulse {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 2px solid var(--signal-secondary);
    opacity: 0;
    animation: verifyPulse 6s ease-out infinite;
}

// ============================================
// L2 - Semantic Field (Middle)
// ============================================
.tier-l2 {
    width: 70%;
    height: 70%;

    .tier-ring {
        border-color: rgba(0, 212, 255, 0.2);
        box-shadow:
            inset 0 0 30px rgba(0, 212, 255, 0.05),
            0 0 20px rgba(0, 212, 255, 0.05);
    }
}

.semantic-field {
    position: absolute;
    inset: 0;
}

.similarity-threads {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
}


// Memory nodes floating in semantic space
.memory-node {
    position: absolute;
    width: 8px;
    height: 8px;
    transform: translate(-50%, -50%);

    &::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 30% 30%,
            rgba(0, 212, 255, 0.7) 0%,
            rgba(0, 212, 255, 0.3) 60%,
            transparent 80%
        );
        border-radius: 50%;
        animation: nodeFloat 4s ease-in-out infinite;
        transition: box-shadow 0.3s, transform 0.3s;
    }

    // Node positions generated from maps (see _variables.scss)
    @each $node, $pos in $node-positions {
        &.#{$node} {
            top: map-get($pos, top);
            left: map-get($pos, left);
        }
    }

    @each $node, $pos in $scattered-positions {
        &.#{$node} {
            top: map-get($pos, top);
            left: map-get($pos, left);
        }
    }

    // Animation delays generated from lists (prime-based for organic feel)
    @for $i from 1 through length($node-delays) {
        &.n#{$i}::before {
            animation-delay: nth($node-delays, $i);
        }
    }

    @for $i from 1 through length($scattered-delays) {
        &.s#{$i}::before {
            animation-delay: nth($scattered-delays, $i);
        }
    }

    // Scattered nodes are slightly smaller and dimmer
    &.scattered {
        width: 6px;
        height: 6px;

        &::before {
            opacity: 0.6;
        }
    }
}

// Cluster highlighting on cache hits - generated from config map
@each $cluster, $config in $cluster-configs {
    $type: map-get($config, type);
    $duration: map-get($config, duration);
    $delay: map-get($config, delay);
    $highlight: if($type == amber, clusterHighlightAmber, clusterHighlight);

    .cluster-#{$cluster}::before {
        animation: nodeFloat 4s ease-in-out infinite, #{$highlight} $duration ease-out $delay infinite;
    }
}

// Edge styling by cluster - matching cluster highlight timing
.edge {
    stroke: var(--signal-primary);
    stroke-width: 1;
    stroke-opacity: 0.15;
    fill: none;
}

// Edge animations generated from cluster config map
@each $cluster, $config in $cluster-configs {
    $type: map-get($config, type);
    $duration: map-get($config, duration);
    $delay: map-get($config, delay);
    $pulse: if($type == amber, edgePulseAmber, edgePulse);

    .edge-#{$cluster} {
        @if $type == amber {
            stroke: var(--signal-secondary);
        }
        animation: #{$pulse} $duration ease-in-out $delay infinite;
    }
}

.edge-scatter {
    stroke: rgba(255, 255, 255, 0.2);
    stroke-dasharray: 3 5;
    opacity: 0.3;
}

// ============================================
// L1 - Exact Match Ring (Innermost)
// ============================================
.tier-l1 {
    width: 40%;
    height: 40%;

    .tier-ring {
        border-color: rgba(0, 212, 255, 0.4);
        border-width: 2px;
        box-shadow:
            0 0 15px rgba(0, 212, 255, 0.2),
            inset 0 0 15px rgba(0, 212, 255, 0.1);
    }
}

.l1-flash {
    position: absolute;
    inset: -5px;
    border-radius: 50%;
    border: 2px solid var(--signal-primary);
    opacity: 0;
    animation: l1Flash 3s ease-out infinite;
}

// ============================================
// Central Proxy Core
// ============================================
.proxy-core {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
}

.core-hexagon {
    position: absolute;
    inset: 0;
    transform-style: preserve-3d;
    animation: hexRotate 20s linear infinite;
}

.hex-face {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 30px;
    height: 52px;
    margin-left: -15px;
    margin-top: -26px;
    background: linear-gradient(180deg,
        rgba(0, 212, 255, 0.3) 0%,
        rgba(0, 212, 255, 0.1) 50%,
        rgba(255, 200, 87, 0.1) 100%
    );
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    backface-visibility: hidden;

    &.hex-1 { transform: rotateY(0deg) translateZ(22px); }
    &.hex-2 { transform: rotateY(60deg) translateZ(22px); }
    &.hex-3 { transform: rotateY(120deg) translateZ(22px); }
    &.hex-4 { transform: rotateY(180deg) translateZ(22px); }
    &.hex-5 { transform: rotateY(240deg) translateZ(22px); }
    &.hex-6 { transform: rotateY(300deg) translateZ(22px); }
}

.core-glow {
    position: absolute;
    inset: -10px;
    background: radial-gradient(circle,
        rgba(0, 212, 255, 0.4) 0%,
        rgba(0, 212, 255, 0.1) 40%,
        transparent 70%
    );
    border-radius: 50%;
    filter: blur(8px);
    animation: coreGlow 3s ease-in-out infinite;
}

.core-pulse {
    position: absolute;
    inset: -20px;
    border-radius: 50%;
    border: 1px solid var(--signal-primary);
    opacity: 0;
    animation: corePulseRing 2s ease-out infinite;
}

// ============================================
// Query Arcs - Incoming Requests
// ============================================
.query-arcs {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

.query-arc {
    position: absolute;
    top: 50%;
    left: 50%;
    transform-origin: center;
}

.query-particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
    border-radius: 2px;
    transform: rotate(45deg);
    box-shadow:
        0 0 8px var(--signal-primary),
        0 0 16px rgba(0, 212, 255, 0.4);
}

// Query animations with varied speeds per arc
// L1 Cache Hits - fastest, bounce at inner ring
.arc-l1 .query-particle {
    animation-name: queryL1Hit;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
}

// L2 Cache Hits - bounce at semantic layer
.arc-l2 .query-particle {
    animation-name: queryL2Hit;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
}

// Cache Misses - go all the way to core
.arc-miss .query-particle {
    animation-name: queryMiss;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
}

// Randomized arc positions with varied speeds and delays
// L1 arcs (base ~6s with variation)
.arc-1 { transform: rotate(7deg); .query-particle { animation-duration: 5.5s; animation-delay: 0s; } }
.arc-5 { transform: rotate(53deg); .query-particle { animation-duration: 6.2s; animation-delay: 1.83s; } }
.arc-8 { transform: rotate(23deg); .query-particle { animation-duration: 5.8s; animation-delay: 3.47s; } }
.arc-12 { transform: rotate(67deg); .query-particle { animation-duration: 6.8s; animation-delay: 0.79s; } }
.arc-14 { transform: rotate(349deg); .query-particle { animation-duration: 6.1s; animation-delay: 4.13s; } }
.arc-18 { transform: rotate(41deg); .query-particle { animation-duration: 6.5s; animation-delay: 2.03s; } }
.arc-22 { transform: rotate(83deg); .query-particle { animation-duration: 5.7s; animation-delay: 5.21s; } }

// L2 arcs (base ~8s with variation)
.arc-2 { transform: rotate(97deg); .query-particle { animation-duration: 7.3s; animation-delay: 0.91s; } }
.arc-6 { transform: rotate(149deg); .query-particle { animation-duration: 8.2s; animation-delay: 3.17s; } }
.arc-9 { transform: rotate(127deg); .query-particle { animation-duration: 7.8s; animation-delay: 1.73s; } }
.arc-13 { transform: rotate(173deg); .query-particle { animation-duration: 8.7s; animation-delay: 4.81s; } }
.arc-15 { transform: rotate(113deg); .query-particle { animation-duration: 7.5s; animation-delay: 2.69s; } }
.arc-19 { transform: rotate(157deg); .query-particle { animation-duration: 8.1s; animation-delay: 0.37s; } }
.arc-23 { transform: rotate(191deg); .query-particle { animation-duration: 9.1s; animation-delay: 5.89s; } }

// Miss arcs (base ~10s with variation - slowest)
.arc-3 { transform: rotate(211deg); .query-particle { animation-duration: 9.2s; animation-delay: 1.03s; } }
.arc-4 { transform: rotate(317deg); .query-particle { animation-duration: 10.3s; animation-delay: 3.91s; } }
.arc-7 { transform: rotate(263deg); .query-particle { animation-duration: 9.8s; animation-delay: 2.47s; } }
.arc-10 { transform: rotate(233deg); .query-particle { animation-duration: 10.9s; animation-delay: 5.17s; } }
.arc-11 { transform: rotate(293deg); .query-particle { animation-duration: 9.5s; animation-delay: 3.37s; } }
.arc-16 { transform: rotate(199deg); .query-particle { animation-duration: 10.6s; animation-delay: 0.73s; } }
.arc-17 { transform: rotate(277deg); .query-particle { animation-duration: 11.2s; animation-delay: 6.61s; } }
.arc-20 { transform: rotate(241deg); .query-particle { animation-duration: 10.1s; animation-delay: 4.29s; } }
.arc-21 { transform: rotate(331deg); .query-particle { animation-duration: 11.8s; animation-delay: 1.67s; } }
.arc-24 { transform: rotate(307deg); .query-particle { animation-duration: 9.4s; animation-delay: 5.59s; } }

// Ring flash effects
.ring-flashes {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

.ring-flash {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    border: 2px solid transparent;
    opacity: 0;

    &.flash-l1 {
        width: 40%;
        height: 40%;
        border-color: var(--signal-primary);
        box-shadow: 0 0 20px var(--signal-primary), inset 0 0 20px rgba(0, 212, 255, 0.3);
        animation: ringFlashL1 1.8s ease-out infinite;
    }

    &.flash-l2 {
        width: 70%;
        height: 70%;
        border-color: var(--signal-primary);
        box-shadow: 0 0 15px var(--signal-primary), inset 0 0 15px rgba(0, 212, 255, 0.2);
        animation: ringFlashL2 2.2s ease-out 0.3s infinite;
    }

    &.flash-l3 {
        width: 100%;
        height: 100%;
        border-color: var(--signal-secondary);
        box-shadow: 0 0 12px var(--signal-secondary), inset 0 0 12px rgba(255, 200, 87, 0.15);
        animation: ringFlashL3 3s ease-out 0.4s infinite;
    }
}

// ============================================
// Cache Hit Effects
// ============================================
.hit-effects {
    position: absolute;
    inset: 0;
    pointer-events: none;
}

.cache-hit {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    opacity: 0;

    &.hit-l1 {
        width: 40%;
        height: 40%;
        border: 2px solid var(--signal-primary);
        box-shadow: 0 0 30px var(--signal-primary);
        animation: hitFlash 5s ease-out infinite;
    }

    &.hit-l2 {
        width: 70%;
        height: 70%;
        border: 2px solid rgba(0, 212, 255, 0.6);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        animation: hitFlash 5s ease-out 2.5s infinite;
    }
}

// ============================================
// Keyframe Animations
// ============================================

@keyframes fieldFloat {
    0%, 100% {
        transform: translateY(0) translateX(0);
        opacity: 0.3;
    }
    25% {
        transform: translateY(-10px) translateX(5px);
        opacity: 0.5;
    }
    50% {
        transform: translateY(-5px) translateX(-5px);
        opacity: 0.3;
    }
    75% {
        transform: translateY(5px) translateX(3px);
        opacity: 0.4;
    }
}

@keyframes l3Rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}


@keyframes verifyPulse {
    0% {
        transform: scale(0.95);
        opacity: 0;
    }
    10% {
        opacity: 0.4;
    }
    50% {
        transform: scale(1.05);
        opacity: 0;
    }
    100% {
        transform: scale(1.05);
        opacity: 0;
    }
}


@keyframes nodeFloat {
    0%, 100% {
        transform: scale(1) translate(0, 0);
    }
    50% {
        transform: scale(1.15) translate(1px, -1px);
    }
}

// Cluster highlight animations - sync with L2 query hits
@keyframes clusterHighlight {
    0%, 40%, 100% {
        box-shadow: none;
        transform: scale(1);
    }
    44% {
        box-shadow: 0 0 12px var(--signal-primary), 0 0 24px rgba(0, 212, 255, 0.7);
        transform: scale(1.5);
    }
    55% {
        box-shadow: 0 0 6px var(--signal-primary);
        transform: scale(1.2);
    }
}

@keyframes clusterHighlightAmber {
    0%, 44%, 100% {
        box-shadow: none;
        transform: scale(1);
    }
    48% {
        box-shadow: 0 0 15px var(--signal-secondary), 0 0 30px rgba(255, 200, 87, 0.6);
        transform: scale(1.6);
    }
    60% {
        box-shadow: 0 0 8px var(--signal-secondary);
        transform: scale(1.2);
    }
}

// Edge pulse animations synced with cluster highlights
@keyframes edgePulse {
    0%, 40%, 100% { stroke-opacity: 0.15; stroke-width: 1; }
    44% { stroke-opacity: 0.8; stroke-width: 2; }
    55% { stroke-opacity: 0.3; stroke-width: 1.5; }
}

@keyframes edgePulseAmber {
    0%, 44%, 100% { stroke-opacity: 0.15; stroke-width: 1; }
    48% { stroke-opacity: 0.7; stroke-width: 2; }
    60% { stroke-opacity: 0.25; stroke-width: 1.5; }
}

@keyframes l1Flash {
    0%, 60%, 100% {
        opacity: 0;
        transform: scale(1);
    }
    65% {
        opacity: 0.8;
        transform: scale(1);
    }
    80% {
        opacity: 0;
        transform: scale(1.3);
    }
}

@keyframes hexRotate {
    from { transform: rotateY(0deg) rotateX(15deg); }
    to { transform: rotateY(360deg) rotateX(15deg); }
}

@keyframes coreGlow {
    0%, 100% {
        opacity: 0.6;
        transform: scale(1);
    }
    50% {
        opacity: 1;
        transform: scale(1.1);
    }
}

@keyframes corePulseRing {
    0% {
        opacity: 0.6;
        transform: scale(0.8);
    }
    100% {
        opacity: 0;
        transform: scale(1.5);
    }
}

// L1 Hit: Bounce at innermost ring (L1) - stops at ~100px
@keyframes queryL1Hit {
    0% {
        left: 170px;
        opacity: 0;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 8px var(--signal-primary), 0 0 16px rgba(0, 212, 255, 0.4);
    }
    5% {
        opacity: 1;
    }
    // Smooth approach to L1 ring
    40% {
        left: 100px;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 15px var(--signal-primary), 0 0 30px rgba(0, 212, 255, 0.6);
    }
    // Impact at L1 ring - brief glow burst, transform to amber
    45% {
        left: 100px;
        transform: rotate(45deg) scale(1.2);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.9) 100%);
        box-shadow: 0 0 25px var(--signal-secondary), 0 0 50px rgba(255, 200, 87, 0.8);
    }
    // Smooth return with amber glow
    90% {
        left: 170px;
        opacity: 1;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.7) 100%);
        box-shadow: 0 0 15px var(--signal-secondary), 0 0 30px rgba(255, 200, 87, 0.5);
    }
    100% {
        left: 170px;
        opacity: 0;
    }
}

// L2 Hit: Bounce at middle ring (L2) - stops at ~130px
@keyframes queryL2Hit {
    0% {
        left: 170px;
        opacity: 0;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 8px var(--signal-primary), 0 0 16px rgba(0, 212, 255, 0.4);
    }
    5% {
        opacity: 1;
    }
    // Smooth approach to L2 ring
    42% {
        left: 130px;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 15px var(--signal-primary), 0 0 30px rgba(0, 212, 255, 0.6);
    }
    // Impact at L2 ring - brief glow burst, transform to amber
    48% {
        left: 130px;
        transform: rotate(45deg) scale(1.2);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.9) 100%);
        box-shadow: 0 0 25px var(--signal-secondary), 0 0 50px rgba(255, 200, 87, 0.8);
    }
    // Smooth return with amber glow
    92% {
        left: 170px;
        opacity: 1;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.7) 100%);
        box-shadow: 0 0 15px var(--signal-secondary), 0 0 30px rgba(255, 200, 87, 0.5);
    }
    100% {
        left: 170px;
        opacity: 0;
    }
}

// Cache Miss: Goes all the way to core - stops at ~35px
@keyframes queryMiss {
    0% {
        left: 170px;
        opacity: 0;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 8px var(--signal-primary), 0 0 16px rgba(0, 212, 255, 0.4);
    }
    5% {
        opacity: 1;
    }
    // Smooth approach to core
    42% {
        left: 35px;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-primary) 50%, rgba(0, 212, 255, 0.6) 100%);
        box-shadow: 0 0 15px var(--signal-primary), 0 0 30px rgba(0, 212, 255, 0.6);
    }
    // Arrive at core - transform to amber
    48% {
        left: 35px;
        transform: rotate(45deg) scale(1.3);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 1) 100%);
        box-shadow: 0 0 30px var(--signal-secondary), 0 0 60px rgba(255, 200, 87, 0.9);
    }
    // Brief dwell at core
    55% {
        left: 35px;
        transform: rotate(45deg) scale(1.2);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.9) 100%);
        box-shadow: 0 0 25px var(--signal-secondary), 0 0 50px rgba(255, 200, 87, 0.8);
    }
    // Smooth return with amber glow
    95% {
        left: 170px;
        opacity: 1;
        transform: rotate(45deg) scale(1);
        background: linear-gradient(135deg, #fff 0%, var(--signal-secondary) 50%, rgba(255, 200, 87, 0.7) 100%);
        box-shadow: 0 0 15px var(--signal-secondary), 0 0 30px rgba(255, 200, 87, 0.5);
    }
    100% {
        left: 170px;
        opacity: 0;
    }
}

// Ring flash when L1 is hit (synced with L1 queries)
@keyframes ringFlashL1 {
    0%, 35%, 100% {
        opacity: 0;
    }
    40% {
        opacity: 0.9;
    }
    55% {
        opacity: 0;
    }
}

// Ring flash for L2 hits - L2 and L3 both flash
@keyframes ringFlashL2 {
    0%, 40%, 100% {
        opacity: 0;
    }
    44% {
        opacity: 0.7;
    }
    60% {
        opacity: 0;
    }
}

// Ring flash for misses - all rings flash
@keyframes ringFlashL3 {
    0%, 42%, 100% {
        opacity: 0;
    }
    46% {
        opacity: 0.5;
    }
    65% {
        opacity: 0;
    }
}

@keyframes hitFlash {
    0%, 45%, 100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1);
    }
    50% {
        opacity: 0.8;
        transform: translate(-50%, -50%) scale(1);
    }
    60% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(1.2);
    }
}

// ============================================
// Responsive
// ============================================
@media (max-width: 1024px) {
    .project-header-layout.has-visual {
        grid-template-columns: 1fr;
    }

    .project-visual {
        display: none;
    }
}
